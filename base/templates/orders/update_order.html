{% extends 'base.html' %}

{% block title %} Add New Oder|| Inventory {% endblock %}

{% block content %}
{% include 'orders/page_header.html' %}

<div class="content">
  <div class="row">
    <div class="col-lg-12">
      <div class="box box-primary">
        <div class="box-header with-border">

          <div class="col">

            <div class="row py-1">
              <h3 class="box-title">Add Orders</h3> <br>
            </div>
            <button onclick="onAddWebsite(event)" class="btn"><i class="fa fa-plus"></i></button>
            <form method="POST" enctype="multipart/form-data" action="" id="invoice_form" data-cities-url={% url 'load-price' %}>

              <div class="row justify-content-end">
               
              </div>
                {% csrf_token %}
                
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">Product Name</th>
<!--                      <th scope="col">Event Name</th>-->
                      <th scope="col">Quantity</th>
                      <th scope="col">Rate</th>
                      <th scope="col">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="tbody">
                   
                    
                    <tr id="fields">
                      {{ form.orderItem }}
                      <td scope="row">{{form.products}}</td>
                      <td>{{ form.quantity }}</td>
                      <td>{{form.price}}</td>
<!--                      <td><input type="number" name="amount" maxlength="100" class="form-control" id="amount" readonly></td>-->
                      <td><a href="#" class="deleteBtn btn" id="delete" onclick="onDeleteRow(event)" >-</a></td>
                    </tr>
                    
                  </tbody>


                </table>
                  <div class="row">
                    
                    <div class="offset-8 col-2 offset-2">Gross Amount<input type="number" name="grand-total" id="grand-total"></div>
                  </div>
                  <div class="row">
                    
                    <div class="offset-8 col-2 offset-2">Date {{form.date_time}}</div>
                  </div>
                  <div class="row">
                    <div class="offset-8 col-2 offset-2">Net Amount<input type="number" name="namount" id="namount"></div>
                  </div>
                <br><br>

        
                <button type="submit" class="btn btn-primary">Save Order</button>
                <button type="submit" class="btn btn-primary">Print Order</button>
        
            </form>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  tr,
  td {
    font-size: small !important;
    font-weight: 600 !important;
  }

</style>




<script src="https://code.jquery.com/jquery-3.3.1.min.js">


</script>

<script>
  
const formEl = document.querySelector("form");
      const tbodyEl = document.querySelector("tbody");
      const tableEl = document.querySelector("table");


  console.log($('#product_name'))  



  function onAddWebsite(e) {
   
       e.preventDefault();
      
       tbodyEl.innerHTML += `
       <tr id="fields">
                      <td scope="row">{{form.Product_id}}</td>
                     
                      <td scope="row">{{form.Event_Name}}</td>
                      <td>{{form.sold_Quantity}}</td>
                      <td>{{ form.price }}</td>
                      <td>{{form.total_price}}</td>
                      <td><a href="#" class="deleteBtn btn" id="delete" onclick="onDeleteRow(event)">-</a></td>
                    </tr>
       `;
     }

function onDeleteRow(e)
{
  
  if (!e.target.classList.contains("deleteBtn")) {
    console.log("H")
          return;
        }

     
  const btn = e.target;
  btn.closest("tr").remove();
}

$('#qty').change(function(){
 
  console.log(this)
  var qty = $('#qty').val()
  var price = $('#price').val()
  
 
  $('#total_price').val(parseInt(qty)*parseInt(price))
  $('#gamount').val(parseInt(qty)*parseInt(price))
  $('#namount').val(parseInt(qty)*parseInt(price))
})

$("#product_name").change(function () {
 
  const url = $("#invoice_form").attr("data-cities-url");  // get the url of the `load_cities` view
        const productID = $(this).val();  // get the selected country ID from the HTML input


        $.ajax({                       // initialize an AJAX request
            url: url,                    // set the url of the request (= /persons/ajax/load-cities/ )
            data: {
                'product_id': productID       // add the product id to the GET parameters
            },
            success: function (data) {   // `data` is the return of the `load_cities` view function
              console.log(data)  
              $("#price").val(data) ;  // replace the contents of the city input with the data that came from the server
                /*

                let html_data = '<option value="">---------</option>';
                data.forEach(function (city) {
                    html_data += `<option value="${city.id}">${city.name}</option>`
                });
                console.log(html_data);
                $("#id_city").html(html_data);

                */
            }
        });

});

function grandTotal(){
  var total=0
    total = $('#amount').val();
    $("#grand-total").val(total);
}

$(document).ready(function() {
$('#grand-total').val();
  $('#id_products').change(function(e){
    e.preventDefault();
    product_id = $(this).val();
                $.ajax({
                url: '/get_product/',
                type: 'get',
                dataType: 'json',
                data: {
                    'product': product_id
                },
                success: function (data) {
                    $('#id_price').val(data.rate)
                    $('#id_quantity').val(1)
              //      $('#amount').val(data.rate)
                    grandTotal();
                    },
                error: function(error) {
                    $('#id_price').val(data.rate)
                    $('#id_quantity').val(1)
                }
        })
    })
      $('#id_quantity').keyup(function(){
        var quantity = $(this).val()
        console.log('HII')
        var rate = $('#id_price').val()
        var quantity = parseInt(quantity, 10);
        if (quantity <= 0){
            var amount = 0
        }
        else{
            var amount = rate * quantity;
            subtotal = (Math.round(amount * 100) / 100).toFixed(2);
            $('#grand-total').val(amount);
            }
    })

})
</script>

{% endblock %}
